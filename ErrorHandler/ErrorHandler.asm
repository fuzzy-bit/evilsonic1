
; ===============================================================
; ---------------------------------------------------------------
; Error handling and debugging modules
; 2016-2017, Vladikcomper
; ---------------------------------------------------------------
; Error handler functions and calls
; ---------------------------------------------------------------

; ---------------------------------------------------------------
; Error handler control flags
; ---------------------------------------------------------------

; Screen appearence flags
_eh_address_error	equ	$01		; use for address and bus errors only (tells error handler to display additional "Address" field)
_eh_show_sr_usp		equ	$02		; displays SR and USP registers content on error screen

; Advanced execution flags
; WARNING! For experts only, DO NOT USES them unless you know what you're doing
_eh_return			equ	$20
_eh_enter_console	equ	$40
_eh_align_offset	equ	$80

; ---------------------------------------------------------------
; Errors vector table
; ---------------------------------------------------------------

; Default screen configuration
_eh_default			equ	0 ;_eh_show_sr_usp

; ---------------------------------------------------------------

BusError:
	__ErrorMessage "BUS ERROR", _eh_default|_eh_address_error

AddressError:
	__ErrorMessage "ADDRESS ERROR", _eh_default|_eh_address_error

IllegalInstr:
	__ErrorMessage "ILLEGAL INSTRUCTION", _eh_default

ZeroDivide:
	__ErrorMessage "ZERO DIVIDE", _eh_default

ChkInstr:
	__ErrorMessage "CHK INSTRUCTION", _eh_default

TrapvInstr:
	__ErrorMessage "TRAPV INSTRUCTION", _eh_default

PrivilegeViol:
	__ErrorMessage "PRIVILEGE VIOLATION", _eh_default

Trace:
	__ErrorMessage "TRACE", _eh_default

Line1010Emu:
	__ErrorMessage "LINE 1010 EMULATOR", _eh_default

Line1111Emu:
	__ErrorMessage "LINE 1111 EMULATOR", _eh_default

ErrorExcept:
	__ErrorMessage "ERROR EXCEPTION", _eh_default



; ---------------------------------------------------------------
; Import error handler global functions
; ---------------------------------------------------------------

ErrorHandler.__global__Error_InitConsole: equ ErrorHandler+$156
ErrorHandler.__global__ErrorHandler_SetupVDP: equ ErrorHandler+$25C
ErrorHandler.__global__Art1bpp_Font: equ ErrorHandler+$354
ErrorHandler.__global__FormatString: equ ErrorHandler+$918
ErrorHandler.__global__Console_LoadPalette: equ ErrorHandler+$A32
ErrorHandler.__global__Console_SetPosAsXY_Stack: equ ErrorHandler+$A6E
ErrorHandler.__global__Console_SetPosAsXY: equ ErrorHandler+$A74
ErrorHandler.__global__Console_GetPosAsXY: equ ErrorHandler+$AA2
ErrorHandler.__global__Console_StartNewLine: equ ErrorHandler+$AC4
ErrorHandler.__global__Console_SetBasePattern: equ ErrorHandler+$AEC
ErrorHandler.__global__Console_SetWidth: equ ErrorHandler+$B00
ErrorHandler.__global__Console_WriteLine_WithPattern: equ ErrorHandler+$B16
ErrorHandler.__global__Console_WriteLine: equ ErrorHandler+$B18
ErrorHandler.__global__Console_Write: equ ErrorHandler+$B1C
ErrorHandler.__global__Console_WriteLine_Formatted: equ ErrorHandler+$BC8
ErrorHandler.__global__Console_Write_Formatted: equ ErrorHandler+$BCC
ErrorHandler.__global__Decomp1bpp: equ ErrorHandler+$BFC


; ---------------------------------------------------------------
; Error handler external functions (compiled only when used)
; ---------------------------------------------------------------


	if ref(ErrorHandler.__extern__ScrollConsole)
ErrorHandler.__extern__ScrollConsole:

	endc

	if ref(ErrorHandler.__extern__Console_Only)
ErrorHandler.__extern__Console_Only:
	dc.l	$46FC2700, $4FEFFFF2, $48E7FFFE, $47EF003C
	jsr		ErrorHandler.__global__ErrorHandler_SetupVDP(pc)
	jsr		ErrorHandler.__global__Error_InitConsole(pc)
	dc.l	$4CDF7FFF, $487A0008, $2F2F0012, $4E7560FE
	endc

	if ref(ErrorHandler.__extern__VSync)
ErrorHandler.__extern__VSync:
	dc.l	$41F900C0, $000444D0, $6BFC44D0, $6AFC4E75
	endc

; ---------------------------------------------------------------
; Error handler blob
; ---------------------------------------------------------------

ErrorHandler:

	dc.l	$46FC2700, $4FEFFFF2, $48E7FFFE, $4EBA024E, $49EF004A, $4E682F08, $47EF0040, $4EBA0138
	dc.l	$41FA02D2, $4EBA0AF6, $225C45D4, $4EBA0B9A, $4EBA0A92, $49D21C19, $6A025249, $47D10806
	dc.l	$00006716, $43FA02B5, $222C0002, $2F012F01, $45D74EBA, $0B74504F, $504C43FA, $02B1222C
	dc.l	$00022F01, $2F0145D7, $4EBA0B5E, $504F2278, $000045EC, $00064EBA, $00EA4EBA, $01BE43FA
	dc.l	$029E2F01, $2F0145D7, $4EBA0B3E, $4EBA0A36, $504F0806, $00066600, $00A845EF, $00044EBA
	dc.l	$0A023F01, $70034EBA, $09CC303C, $64307A07, $4EBA011A, $321F7011, $4EBA09BA, $303C6130
	dc.l	$7A064EBA, $0108303C, $73707A00, $2F0C45D7, $4EBA00FA, $584F0806, $00016714, $43FA0251
	dc.l	$45D74EBA, $0AE843FA, $025245D4, $4EBA0ADA, $584F4EBA, $09AE5241, $70014EBA, $09782038
	dc.l	$007841FA, $02404EBA, $00F22038, $007041FA, $023C4EBA, $00E64EBA, $09AC2278, $000045D4
	dc.l	$5389613E, $4EBA097C, $7A199A41, $6B0A6146, $4EBA0058, $51CDFFFA, $08060005, $660860FE
	dc.l	$72004EBA, $09A82ECB, $4CDF7FFF, $487AFFF0, $2F2FFFC4, $4E7543FA, $015845FA, $01F84EFA
	dc.l	$088E223C, $00FFFFFF, $2409C481, $2242240A, $C4812442, $4E754FEF, $FFD041D7, $7EFF20FC
	dc.l	$28535029, $30FC3A20, $60184FEF, $FFD041D7, $7EFF30FC, $202B320A, $924C4EBA, $05AA30FC
	dc.l	$3A207005, $72ECB5C9, $650272EE, $10C1321A, $4EBA05B2, $10FC0020, $51C8FFEA, $421841D7
	dc.l	$72004EBA, $09524FEF, $00304E75, $4FEFFFF0, $7EFF41D7, $30C030FC, $3A2010FC, $00EC221A
	dc.l	$4EBA057A, $421841D7, $72004EBA, $092A5240, $51CDFFE0, $4FEF0010, $4E752200, $48414601
	dc.l	$6620514F, $2E882440, $43FA0021, $0C5A4EF9, $660843FA, $00102F52, $000445D7, $4EBA09AE
	dc.l	$504F4E75, $D0E8BFEC, $C8E000D0, $E83C756E, $64656669, $6E65643E, $E0005989, $B3CA650C
	dc.l	$0C520040, $650A548A, $B3CA64F4, $72004E75, $221267F2, $08010000, $66EC4E75, $4BF900C0
	dc.l	$00044DED, $FFFC4A55, $44D569FC, $41FA0026, $30186A04, $3A8060F8, $70002ABC, $40000000
	dc.l	$2C802ABC, $40000010, $2C802ABC, $C0000000, $3C804E75, $80048134, $82208404, $85008700
	dc.l	$8B008C81, $8D008F02, $90119100, $92000000, $44000000, $00000001, $00100011, $01000101
	dc.l	$01100111, $10001001, $10101011, $11001101, $11101111, $FFFF4000, $00020028, $00280000
	dc.l	$008000FF, $0EEEFFF2, $00CEFFF2, $0EEAFFF2, $0E86FFF2, $EAE0FA01, $F02600EA, $41646472
	dc.l	$6573733A, $20EC8320, $E8BFECC8, $00EA4D6F, $64756C65, $3A20EC83, $20E8BFEC, $C800EA43
	dc.l	$616C6C65, $723A20EC, $8320E8BF, $ECC800FA, $10E87573, $703A20EC, $8300FA03, $E873723A
	dc.l	$20EC8100, $EA56496E, $743A2000, $EA48496E, $743A2000, $02F70000, $00000000, $0000183C
	dc.l	$3C181800, $18006C6C, $6C000000, $00006C6C, $FE6CFE6C, $6C00187E, $C07C06FC, $180000C6
	dc.l	$0C183060, $C600386C, $3876CCCC, $76001818, $30000000, $00001830, $60606030, $18006030
	dc.l	$18181830, $600000EE, $7CFE7CEE, $00000018, $187E1818, $00000000, $00001818, $30000000
	dc.l	$00FE0000, $00000000, $00000038, $3800060C, $183060C0, $80007CC6, $CEDEF6E6, $7C001878
	dc.l	$18181818, $7E007CC6, $0C183066, $FE007CC6, $063C06C6, $7C000C1C, $3C6CFE0C, $0C00FEC0
	dc.l	$FC0606C6, $7C007CC6, $C0FCC6C6, $7C00FEC6, $060C1818, $18007CC6, $C67CC6C6, $7C007CC6
	dc.l	$C67E06C6, $7C00001C, $1C00001C, $1C000018, $18000018, $18300C18, $30603018, $0C000000
	dc.l	$FE0000FE, $00006030, $180C1830, $60007CC6, $060C1800, $18007CC6, $C6DEDCC0, $7E00386C
	dc.l	$C6C6FEC6, $C600FC66, $667C6666, $FC003C66, $C0C0C066, $3C00F86C, $6666666C, $F800FEC2
	dc.l	$C0F8C0C2, $FE00FE62, $607C6060, $F0007CC6, $C0C0DEC6, $7C00C6C6, $C6FEC6C6, $C6003C18
	dc.l	$18181818, $3C003C18, $1818D8D8, $7000C6CC, $D8F0D8CC, $C600F060, $60606062, $FE00C6EE
	dc.l	$FED6D6C6, $C600C6E6, $E6F6DECE, $C6007CC6, $C6C6C6C6, $7C00FC66, $667C6060, $F0007CC6
	dc.l	$C6C6C6D6, $7C06FCC6, $C6FCD8CC, $C6007CC6, $C07C06C6, $7C007E5A, $18181818, $3C00C6C6
	dc.l	$C6C6C6C6, $7C00C6C6, $C6C66C38, $1000C6C6, $D6D6FEEE, $C600C66C, $3838386C, $C6006666
	dc.l	$663C1818, $3C00FE86, $0C183062, $FE007C60, $60606060, $7C00C060, $30180C06, $02007C0C
	dc.l	$0C0C0C0C, $7C001038, $6CC60000, $00000000, $00000000, $00FF3030, $18000000, $00000000
	dc.l	$780C7CCC, $7E00E060, $7C666666, $FC000000, $7CC6C0C6, $7C001C0C, $7CCCCCCC, $7E000000
	dc.l	$7CC6FEC0, $7C001C36, $30FC3030, $78000000, $76CEC67E, $067CE060, $7C666666, $E6001800
	dc.l	$38181818, $3C000C00, $1C0C0C0C, $CC78E060, $666C786C, $E6001818, $18181818, $1C000000
	dc.l	$6CFED6D6, $C6000000, $DC666666, $66000000, $7CC6C6C6, $7C000000, $DC66667C, $60F00000
	dc.l	$76CCCC7C, $0C1E0000, $DC666060, $F0000000, $7CC07C06, $7C003030, $FC303036, $1C000000
	dc.l	$CCCCCCCC, $76000000, $C6C66C38, $10000000, $C6C6D6FE, $6C000000, $C66C386C, $C6000000
	dc.l	$C6C6CE76, $067C0000, $FC983064, $FC000E18, $18701818, $0E001818, $18001818, $18007018
	dc.l	$180E1818, $700076DC, $00000000, $000043FA, $05C80C59, $DEB26672, $70FED059, $74FC7600
	dc.l	$48410241, $00FFD241, $D241B240, $625C675E, $20311000, $675847F1, $08004841, $7000301B
	dc.l	$B253654C, $43F308FE, $45E9FFFC, $E248C042, $B2730000, $65146204, $D6C0601A, $47F30004
	dc.l	$200A908B, $6AE6594B, $600C45F3, $00FC200A, $908B6AD8, $47D2925B, $7400341B, $D3C24841
	dc.l	$42414841, $D2837000, $4E7570FF, $4E754841, $70003001, $D6805283, $323CFFFF, $48415941
	dc.l	$6A8E70FF, $4E7547FA, $05300C5B, $DEB2664A, $D6D37800, $72007400, $45D351CC, $00061619
	dc.l	$7807D603, $D3415242, $B252620A, $65ECB42A, $00026712, $65E4584A, $B25262FA, $65DCB42A
	dc.l	$000265D6, $66F010EA, $0003670A, $51CFFFC6, $4E9464C0, $4E755348, $4E757000, $4E754EFA
	dc.l	$00244EFA, $0018760F, $3401E84A, $C44310FB, $205E51CF, $004C4E94, $64464E75, $48416104
	dc.l	$654A4841, $7404760F, $E5791801, $C84310FB, $403E51CF, $00044E94, $6532E579, $1801C843
	dc.l	$10FB402C, $51CF0004, $4E946520, $E5791801, $C84310FB, $401A51CF, $00044E94, $650EE579
	dc.l	$C24310FB, $100A51CF, $00044ED4, $4E753031, $32333435, $36373839, $41424344, $45464EFA
	dc.l	$00264EFA, $001A7407, $7018D201, $D10010C0, $51CF0006, $4E946504, $51CAFFEE, $4E754841
	dc.l	$61046518, $4841740F, $7018D241, $D10010C0, $51CF0006, $4E946504, $51CAFFEE, $4E754EFA
	dc.l	$00104EFA, $004847FA, $009A0241, $00FF6004, $47FA008C, $42007609, $381B3403, $924455CA
	dc.l	$FFFCD244, $94434442, $8002670E, $06020030, $10C251CF, $00064E94, $6510381B, $6ADC0601
	dc.l	$003010C1, $51CF0004, $4ED44E75, $47FA002E, $42007609, $281B3403, $928455CA, $FFFCD284
	dc.l	$94434442, $8002670E, $06020030, $10C251CF, $00064E94, $65D4281B, $6ADC609E, $3B9ACA00
	dc.l	$05F5E100, $00989680, $000F4240, $000186A0, $00002710, $FFFF03E8, $0064000A, $FFFF2710
	dc.l	$03E80064, $000AFFFF, $48C16008, $4EFA0006, $488148C1, $48E75060, $4EBAFD94, $66182E81
	dc.l	$4EBAFE24, $4CDF060A, $650A0803, $00036604, $4EFA00B6, $4E754CDF, $060A0803, $00026708
	dc.l	$47FA000A, $4EFA00B4, $70FF60DE, $3C756E6B, $6E6F776E, $3E0010FC, $002B51CF, $00064E94
	dc.l	$65D24841, $4A416700, $FE5A6000, $FE520803, $000366C0, $4EFAFE46, $48E7F810, $10D95FCF
	dc.l	$FFFC6E14, $67181620, $7470C403, $4EBB201A, $64EA4CDF, $081F4E75, $4E9464E0, $60F45348
	dc.l	$4E944CDF, $081F4E75, $47FAFDF4, $B702D402, $4EFB205A, $4E714E71, $47FAFEA4, $B702D402
	dc.l	$4EFB204A, $4E714E71, $47FAFE54, $B702D402, $4EFB203A, $53484E75, $47FAFF2E, $14030242
	dc.l	$0003D442, $4EFB2026, $4A406B08, $4A816716, $4EFAFF64, $4EFAFF78, $265A10DB, $57CFFFFC
	dc.l	$67D24E94, $64F44E75, $5248603C, $504B321A, $4ED3584B, $221A4ED3, $52486022, $504B321A
	dc.l	$6004584B, $221A6A08, $448110FC, $002D6004, $10FC002B, $51CF0006, $4E9465CA, $4ED351CF
	dc.l	$00064E94, $65C010D9, $51CFFFBC, $4ED44BF9, $00C00004, $4DEDFFFC, $4A516B10, $2A9941D2
	dc.l	$38184EBA, $01F843E9, $002060EC, $54494E63, $2A1926C5, $26D926D9, $36FC434F, $47FA003A
	dc.l	$2A857000, $32194E93, $2ABC4000, $00007200, $4E932ABC, $C0000000, $70007603, $3C803419
	dc.l	$3C823419, $6AFA7200, $4EB32010, $51CBFFEE, $3ABC8174, $2A854E75, $2C802C80, $2C802C80
	dc.l	$2C802C80, $2C802C80, $51C9FFEE, $4E754CAF, $00030004, $48E76010, $4E6B0C6B, $434F000C
	dc.l	$661A3413, $0242E000, $C2EB000A, $D441D440, $D4403682, $23DB00C0, $000436DB, $4CDF0806
	dc.l	$4E752F0B, $4E6B0C6B, $434F000C, $66127200, $32130241, $1FFF82EB, $000A2001, $4840E248
	dc.l	$265F4E75, $2F0B4E6B, $0C6B434F, $000C6618, $3F003013, $D06B000A, $02405FFF, $368023DB
	dc.l	$00C00004, $36DB301F, $265F4E75, $2F0B4E6B, $0C6B434F, $000C6604, $37410008, $265F4E75
	dc.l	$2F0B4E6B, $0C6B434F, $000C6606, $584B36C1, $36C1265F, $4E7561D4, $487AFFAA, $48E77E12
	dc.l	$4E6B0C6B, $434F000C, $661C2A1B, $4C93005C, $48464DF9, $00C00000, $72001218, $6E0E6B28
	dc.l	$4893001C, $27054CDF, $487E4E75, $51CB000E, $D642DA86, $0885001D, $2D450004, $D2443C81
	dc.l	$72001218, $6EE667D8, $0241001E, $4EFB1002, $DA86721D, $03856020, $6026602A, $6032603A
	dc.l	$14186014, $181860D8, $60361218, $D2417680, $4843CA83, $48418A81, $36022D45, $000460C0
	dc.l	$024407FF, $60BA0244, $07FF0044, $200060B0, $024407FF, $00444000, $60A60044, $600060A0
	dc.l	$3F041E98, $381F6098, $487AFEFA, $2F0C49FA, $00164FEF, $FFF041D7, $7E0E4EBA, $FD3C4FEF
	dc.l	$0010285F, $4E754218, $44470647, $000F90C7, $2F084EBA, $FF28205F, $7E0E4E75, $741E1018
	dc.l	$1200E609, $C2423CB1, $1000D000, $C0423CB1, $000051CC, $FFEA4E75

; ---------------------------------------------------------------
; WARNING!
;	DO NOT put any data from now on! DO NOT use ROM padding!
;	Symbol data should be appended here after ROM is compiled
;	by ConvSym utility, otherwise debugger modules won't be able
;	to resolve symbol names.
; ---------------------------------------------------------------
